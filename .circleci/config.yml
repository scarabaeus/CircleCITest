version: 2.1
orbs:
  slack: circleci/slack@3.4.0

jobs:
  build:
    docker:
      - image: circleci/node:7.10
    steps:
      - checkout
      - run: echo "Run Build"

  test:
    docker:
      - image: circleci/node:7.10
    steps:
      - run: 
          name: "Setup custom environment variables"
          command: |
            echo 'export DEPLOYMENT_BUNDLE_NAME="${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BRANCH}.${CIRCLE_BUILD_NUM}.${CIRCLE_SHA1}.zip"' >> $BASH_ENV
      - slack/notify:
          channel: 'returns-deployment'
          color: '#bada55'
          title: ':package: ${CIRCLE_PROJECT_REPONAME} repo deployment package created'
          title_link: '${CIRCLE_COMPARE_URL}'
          message: '*Branch:* ${CIRCLE_BRANCH} - *Initiator:* ${CIRCLE_USERNAME} ${CIRCLE_PULL_REQUEST}'
          footer: 'To deploy: \`git tag ${CIRCLE_SHA1} <environment>\`'
          webhook: '${SLACK_WEBHOOK}'
          include_project_field: false
          include_job_number_field: false


  retrieve_package:
    docker:
      - image: circleci/node:7.10
    steps:
      - run: echo "Run Retrieve"
  
  qa_deploy:
    docker:
      - image: circleci/node:7.10
    steps:
      - slack/notify:
          channel: 'returns-deployment'
          mentions: 'jin.chen,ankush.goyal,steve'
          color: '#ffffff'
          message: 'Deploying CIRCLE_SHA1 to *QA*.'
          webhook: '${SLACK_WEBHOOK}'
      - run: 
          name: "Setup custom environment variables"
          command: |
            echo 'export DEPLOYMENT_BUNDLE_NAME="${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BRANCH}.${CIRCLE_BUILD_NUM}.${CIRCLE_SHA1}.zip"' >> $BASH_ENV
      - run:
          name: "My Deployment Output"
          command: echo ${CIRCLE_BRANCH}
      - run:
          name: "Deployment Bundle"
          command: echo ${DEPLOYMENT_BUNDLE_NAME}
      - slack/notify:
          channel: 'returns-deployment'
          color: '#ffffff'
          title: ':white_circle: ${CIRCLE_PROJECT_REPONAME} deployed to *QA*'
          title_link: '${CIRCLE_COMPARE_URL}'
          message: '*Branch:* ${CIRCLE_BRANCH} - *Initiator:* ${CIRCLE_USERNAME} ${CIRCLE_PULL_REQUEST}'
          webhook: '${SLACK_WEBHOOK}'
          include_project_field: false
          include_job_number_field: false

  stage_deploy:
    docker:
      - image: circleci/node:7.10
    steps:
      - slack/notify:
          channel: 'returns-deployment'
          color: '#0000ff'
          message: 'Deploying CIRCLE_SHA1 to *STAGING*'
          webhook: '${SLACK_WEBHOOK}'
      - run: 
          name: "Setup custom environment variables"
          command: |
            echo 'export DEPLOYMENT_BUNDLE_NAME="${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BRANCH}.${CIRCLE_BUILD_NUM}.${CIRCLE_SHA1}.zip"' >> $BASH_ENV
      - run:
          name: "My Deployment Output"
          command: echo ${CIRCLE_BRANCH}
      - run:
          name: "Deployment Bundle"
          command: echo ${DEPLOYMENT_BUNDLE_NAME}
      - slack/notify:
          channel: 'returns-deployment'
          color: '#0000ff'
          title: ':large_blue_circle: ${CIRCLE_PROJECT_REPONAME} deployed to *STAGING*'
          title_link: '${CIRCLE_COMPARE_URL}'
          message: '*Branch:* ${CIRCLE_BRANCH} - *Initiator:* ${CIRCLE_USERNAME} ${CIRCLE_PULL_REQUEST}'
          webhook: '${SLACK_WEBHOOK}'
          include_project_field: false
          include_job_number_field: false

  request_prod_deploy_approval:
    docker:
      - image: circleci/node:7.10
    steps:
      - run:
          name: "Requesting approval"
          command: echo S

  prod_deploy:
    docker:
      - image: circleci/node:7.10
    steps:
      - slack/notify:
          channel: 'returns-deployment'
          color: '#ff0000'
          title: ':red_circle: ${CIRCLE_PROJECT_REPONAME} PRODUCTION deployment initiated'
          message: 'Deploying CIRCLE_SHA1 to *PRODUCTION*.'
          webhook: '${SLACK_WEBHOOK}'
          include_project_field: false
          include_job_number_field: false
      - run: 
          name: "Setup custom environment variables"
          command: |
            echo 'export DEPLOYMENT_BUNDLE_NAME="${CIRCLE_PROJECT_REPONAME}-${CIRCLE_BRANCH}.${CIRCLE_BUILD_NUM}.${CIRCLE_SHA1}.zip"' >> $BASH_ENV
      - run:
          name: "My Deployment Output"
          command: echo ${CIRCLE_BRANCH}
      - run:
          name: "Deployment Bundle"
          command: echo ${DEPLOYMENT_BUNDLE_NAME}
      - slack/notify:
          channel: 'returns-deployment'
          color: '#ff0000'
          title: ':red_circle: ${CIRCLE_PROJECT_REPONAME} deployed to PRODUCTION'
          message: '*Initiator:* ${CIRCLE_USERNAME}'
          webhook: '${SLACK_WEBHOOK}'
          include_project_field: false
          include_job_number_field: false
      
workflows:
  version: 2
  CircleCITest_CI_Build:
    jobs:
      - build
      - test:
          requires: 
            - build

  CircleCITest_Deploy_Prod:
    jobs:
      - request_prod_deploy_approval:
          type: approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^deploy-production-.*$/
      - prod_deploy:
          requires:
            - request_prod_deploy_approval

  CircleCITest_Deploy_Stage:
    jobs:
      - stage_deploy:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^deploy-stage-.*$/

  CircleCITest_Deploy_QA:
    jobs:
      - qa_deploy:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^deploy-(qa01|qa02)-.*$/

  

        

# version: 2
# jobs:
#   build:
#     docker:
#       - image: circleci/node:7.10
#     steps:
#       - checkout
#       - restore_cache:
#         - run: echo "Build Test"

#   deploy: 
#     filters:
#       tags:
#         only: /^\d+\.\d+\.\d+$/
#     steps:
#       - run: echo "Deploy Test"

# workflows:
#   version: 2
#   CircleCITest_build:
#     jobs:
#       - build
  # CircleCITest_deploy:
  #   filters:
  #     branches:
  #       ignore: /.*/
  #     tags:
  #       only: /^\d+\.\d+\.\d+$/
  #   jobs:
  #      - deploy
